DROP TRIGGER SYSADM.IBP_CONTR_SERV_CAP;

CREATE OR REPLACE TRIGGER SYSADM.IBP_CONTR_SERV_CAP
AFTER INSERT OR UPDATE OF CS_ACTIV_DATE ON SYSADM.CONTR_SERVICES_CAP FOR EACH ROW
DECLARE 
    PRAGMA AUTONOMOUS_TRANSACTION;
    DN NUMBER;
BEGIN  
IF ( :NEW.SEQNO > 1  AND :NEW.CS_ACTIV_DATE IS NOT NULL ) THEN
SELECT DN_ID INTO DN FROM CONTR_SERVICES_CAP WHERE CO_ID=:NEW.CO_ID AND SEQNO=:NEW.SEQNO-1;
INSERT INTO IBP_STAGING   ( REQ_ID, TIMESTAMP,      CO_ID,       SEQ,    OLD_VAL,  NEW_VAL,     ACTION_ID) 
     VALUES ( IBP_STAGING_SEQ.NEXTVAL, SYSDATE, :NEW.CO_ID, :NEW.SEQNO, DN, :NEW.DN_ID, 9) ;
     COMMIT;
END IF;    
END;
/

