DROP TRIGGER SYSADM.IBP_RATEPLAN_SY;

CREATE OR REPLACE TRIGGER SYSADM.IBP_RATEPLAN_SY
AFTER INSERT OR UPDATE OF TMCODE ON SYSADM.RATEPLAN_HIST FOR EACH ROW
DECLARE 
    PRAGMA AUTONOMOUS_TRANSACTION;
TM NUMBER;
BEGIN  
CASE 
WHEN INSERTING AND :NEW.SEQNO>1 THEN
SELECT TMCODE INTO TM FROM RATEPLAN_HIST WHERE CO_ID=:NEW.CO_ID AND SEQNO=:NEW.SEQNO-1;
INSERT INTO IBP_STAGING   ( REQ_ID, TIMESTAMP,      CO_ID,       SEQ,      TMCODE,    OLD_VAL,  NEW_VAL,     ACTION_ID ) 
     VALUES ( IBP_STAGING_SEQ.NEXTVAL, SYSDATE, :NEW.CO_ID, :NEW.SEQNO, :NEW.TMCODE, TM, :NEW.TMCODE, 12) ;
     COMMIT;
WHEN UPDATING THEN
INSERT INTO IBP_STAGING   ( REQ_ID, TIMESTAMP,      CO_ID,       SEQ,      TMCODE,    OLD_VAL,  NEW_VAL,     ACTION_ID ) 
     VALUES ( IBP_STAGING_SEQ.NEXTVAL, SYSDATE, :NEW.CO_ID, :NEW.SEQNO, :NEW.TMCODE, :OLD.TMCODE, :NEW.TMCODE, 12) ;
     COMMIT;
ELSE TM:=1;
END CASE;    
END;
/

