DROP TRIGGER SYSADM.IBP_CONTR_DEVICES;

CREATE OR REPLACE TRIGGER SYSADM.IBP_CONTR_DEVICES
AFTER INSERT OR UPDATE OF CD_ACTIV_DATE ON SYSADM.CONTR_DEVICES FOR EACH ROW
DECLARE 
    PRAGMA AUTONOMOUS_TRANSACTION;
    PT VARCHAR2(50);
BEGIN  
IF ( :NEW.CD_SEQNO > 1 AND :NEW.CD_ACTIV_DATE IS NOT NULL ) THEN
SELECT CD_PORT_NUM INTO PT FROM CONTR_DEVICES WHERE CO_ID=:NEW.CO_ID AND CD_SEQNO=:NEW.CD_SEQNO-1;
INSERT INTO IBP_STAGING   ( REQ_ID, TIMESTAMP,      CO_ID,       SEQ,    OLD_VAL,  NEW_VAL,     ACTION_ID ) 
     VALUES ( IBP_STAGING_SEQ.NEXTVAL, SYSDATE, :NEW.CO_ID, :NEW.CD_SEQNO, PT, :NEW.CD_PORT_NUM, 8) ;
     COMMIT;
END IF;    
END;
/

