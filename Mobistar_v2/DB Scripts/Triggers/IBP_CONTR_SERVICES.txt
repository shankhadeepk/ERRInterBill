DROP TRIGGER SYSADM.IBP_CONTR_SERVICES;

CREATE OR REPLACE TRIGGER SYSADM.IBP_CONTR_SERVICES
AFTER UPDATE
OF CS_STAT_CHNG
  ,CS_SPARAM1
ON SYSADM.CONTR_SERVICES 
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
FLG CHAR;

BEGIN
IF (LENGTH(NVL(:OLD.CS_STAT_CHNG, 0)) < LENGTH(NVL(:NEW.CS_STAT_CHNG, 0))) THEN
SELECT MAX('X') INTO FLG FROM CONTRACT_HISTORY WHERE CO_ID=:NEW.CO_ID AND (CH_PENDING='X' OR CH_STATUS='d');
IF ( NVL(FLG, 'O') <> 'X' AND SUBSTR(:NEW.CS_STAT_CHNG, -1) <> 's' AND nvl(SUBSTR(:OLD.CS_STAT_CHNG, -1),'i') <> 's') THEN
INSERT INTO IBP_STAGING ( REQ_ID, TIMESTAMP, CO_ID, SEQ, TMCODE ,SNCODE, OLD_VAL,NEW_VAL,ACTION_ID, CS_PARAM1)
VALUES ( IBP_STAGING_SEQ.NEXTVAL, SYSDATE, :NEW.CO_ID, :NEW.CS_SEQNO, :NEW.TMCODE,:NEW.SNCODE,:OLD.CS_STAT_CHNG,:NEW.CS_STAT_CHNG,
DECODE ( SUBSTR(:NEW.CS_STAT_CHNG,-1, 1 ), 'a', 5, 'd',6, 's', 6 ), :NEW.CS_SPARAM1) ;
END IF;
END IF;
IF (NVL(:OLD.CS_SPARAM1, 0) <> NVL(:NEW.CS_SPARAM1, 0) AND :OLD.CS_STAT_CHNG IS NOT NULL ) THEN
INSERT INTO IBP_STAGING ( REQ_ID, TIMESTAMP, CO_ID, SEQ, TMCODE ,SNCODE, OLD_VAL,NEW_VAL,ACTION_ID, CS_PARAM1)
VALUES ( IBP_STAGING_SEQ.NEXTVAL, SYSDATE, :NEW.CO_ID, :NEW.CS_SEQNO, :NEW.TMCODE,:NEW.SNCODE,:OLD.CS_SPARAM1,:NEW.CS_SPARAM1,7, :NEW.CS_SPARAM1) ;
END IF;
END;
/

